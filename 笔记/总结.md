### 文件上传

#### 什么是文件上传漏洞？

服务端没有对客户端上传的文件进行严格验证或过滤，用户可以上传一个可执行的脚本文件，并通过此脚本获得了执行服务器命令的能力。

#### 危害如何？

1.上传大量的大文件或特定格式的文件耗尽服务器存储空间或处理资源造成DOS攻击

2.上传webshell获取服务器权限

3.上传含有病毒的文件，诱使用户下载，造成恶意软件传播

4.上传包含恶意JS的html，诱使用户访问造成跨站脚本攻击

#### 绕过方式？

##### 前端JS检测绕过

上传正常后缀的文件如带有木马的图片，抓包修改上传文件的后缀。



##### 服务器MIME类型检测

更改POST报文中的content-type字段的内容



##### 黑名单检测(文件后缀名检测)

随意构造一个必定不在黑名单列表的后缀名，若能上传则是黑名单检测

1.利用后缀大小写进行绕过，Windows中对大小写不敏感

2.利用空格绕过，WIndows保存文件会自动去除末尾的空格

3.利用点'  .  ' 绕过，Windows保存文件会自动去除末尾的'  .  '

4.利用::$DATA绕过，shell.jsp::$DATA 会把::$DATA之后的数据当成文件流处理，不会检测后缀名，且保持::$DATA之前的文件名

5.抓包把文件名改成 1.php/.  看似这成了文件夹的名字，实则还是会保存为1.php文件



##### 白名单检测

1.%00截断

要求：php<5.3.29,GPC处于关闭状态

在数据包中，含有上传后文件目录的情况才可使用。比如在数据包中存在path：/uploads/

这种情况，可以这样上传/uploads/1.php%00.jpg

2.配合低版本中间件解析漏洞

3.阿帕奇中间件上传.htaccess绕过

4.fuzz畸形扩展名绕过



##### 文件内容检测

winhex打开文件把文件头修改成合法的



##### 针对有缺陷的上传流程

不规范的上传流程：服务器在获取请求后，先移动文件至指定目录，再判断文件是否有效，若无效，则删除。

条件竞争：由于服务器不能删除正在使用的文件，所以可以脚本一直上传shell，在shell被代码删除之前访问它，则可以上传成功。

#### 文件上传漏洞出现在什么地方？

1.用户头像上传

2.文档上传

3.图像和音视频上传

4.在线表单和作业提交



#### 修复方案？

1.通过设置白名单方式来判定上传文件后缀是否合法

2.对上传的文件随机重命名，避免攻击者猜测文件名访问webshell

3.把上传的文件保存到网站用户访问不到的目录

4.把存放上传文件的目录的可执行权限去掉，配置为不解析任何脚本文件

5.限制上传文件的大小

6.定期对存放上传文件的目录木马查杀



### SQL注入

#### 什么是sql注入？

#### 危害？

#### sql注入常见函数？

#### 绕过姿势？

#### 可能出现sql注入的地方？

#### 修复方案？