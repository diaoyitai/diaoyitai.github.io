### 文件上传

#### 什么是文件上传漏洞？

服务端没有对客户端上传的文件进行严格验证或过滤，用户可以上传一个可执行的脚本文件，并通过此脚本获得了执行服务器命令的能力。

#### 危害如何？

1.上传大量的大文件或特定格式的文件耗尽服务器存储空间或处理资源造成DOS攻击

2.上传webshell获取服务器权限

3.上传含有病毒的文件，诱使用户下载，造成恶意软件传播

4.上传包含恶意JS的html，诱使用户访问造成跨站脚本攻击

#### 绕过方式？

##### 前端JS检测绕过

上传正常后缀的文件如带有木马的图片，抓包修改上传文件的后缀。



##### 服务器MIME类型检测

更改POST报文中的content-type字段的内容



##### 黑名单检测(文件后缀名检测)

随意构造一个必定不在黑名单列表的后缀名，若能上传则是黑名单检测

1.利用后缀大小写进行绕过，Windows中对大小写不敏感

2.利用空格绕过，WIndows保存文件会自动去除末尾的空格

3.利用点'  .  ' 绕过，Windows保存文件会自动去除末尾的'  .  '

4.利用::$DATA绕过，shell.jsp::$DATA 会把::$DATA之后的数据当成文件流处理，不会检测后缀名，且保持::$DATA之前的文件名

5.抓包把文件名改成 1.php/.  看似这成了文件夹的名字，实则还是会保存为1.php文件



##### 白名单检测

1.%00截断

要求：php<5.3.29,magic_quotes_gpc处于关闭状态

在数据包中，含有上传后文件目录的情况才可使用。比如在数据包中存在path：/uploads/

这种情况，可以这样上传/uploads/1.php%00.jpg

2.配合低版本中间件解析漏洞

3.阿帕奇中间件上传.htaccess绕过

4.fuzz畸形扩展名绕过



##### 文件内容检测

winhex打开文件把文件头修改成合法的



##### 针对有缺陷的上传流程

不规范的上传流程：服务器在获取请求后，先移动文件至指定目录，再判断文件是否有效，若无效，则删除。

条件竞争：由于服务器不能删除正在使用的文件，所以可以脚本一直上传shell，在shell被代码删除之前访问它，则可以上传成功。

#### 文件上传漏洞出现在什么地方？

1.用户头像上传

2.文档上传

3.图像和音视频上传

4.在线表单和作业提交



#### 修复方案？

1.通过设置白名单方式来判定上传文件后缀是否合法

2.对上传的文件随机重命名，避免攻击者猜测文件名访问webshell

3.把上传的文件保存到网站用户访问不到的目录

4.把存放上传文件的目录的可执行权限去掉，配置为不解析任何脚本文件

5.限制上传文件的大小

6.定期对存放上传文件的目录木马查杀



### SQL注入

#### 什么是sql注入？

sql注入是没有对用户的输入进行适当的处理和过滤，从而将攻击者的恶意sql语句插入到服务端正常的sql语句执行，使sql查询的语法和逻辑发生变化，从而达到操作数据库的目的。

#### 危害？

1.攻击者未经授权可以访问数据库中的数据，盗取用户的隐私以及个人信息。

2.可以对数据库的数据进行添加或删除操作，例如私自添加管理员账号。

3.如果网站目录存在写入权限，可以写入webshell。

4.经过提权等步骤，服务器最高权限被攻击者获取。

#### sql注入的类型和常见函数？

##### 基于错误的sql注入

攻击者通过在输入中插入错误的sql代码，导致数据库返回错误，可以在报错信息中获取想要的数据。

常见函数：exp()、updataxml()、extractvalue()



##### union联合查询注入

攻击者使用union语句将恶意查询结果与合法查询结果结合起来，获取数据库中敏感信息。

常见函数：concat()、concat_ws()、group_concat



##### 布尔盲注

攻击者通过构造条件语句，根据应用程序返回的两种不同响应，逐步推断出数据库中的信息。

常见函数：length()、substr()、mid()、rigth()、left()、ascii()、ord()



##### 时间盲注

攻击者通过构造延时函数，根据应用程序的响应的延迟时间，推断出数据库中的信息。

常见函数：sleep()、if()



##### 堆叠注入

攻击者通过在输入中用分号  ;  加入多个查询语句，使数据库执行多个独立的SQL语句，从而实现复杂的攻击。



##### 读写文件函数

load_file()读取文件

```sql
union select 1,2,load_file('/etc/passwd')
```

into outfile、into dumpfile 写文件

```sql
union select 1,2,"<?php @eval($_POST[cmd]);?>" into dumpfile '/var/www/html/a.php' 
```



#### 绕过姿势？

1.双写、大小写关键字

2.被反斜杠转义\：宽字节注入%DF%5C(\)被gbk编码成生僻字

3.等价函数绕过

4.空格绕过：%20，%a0，括号（）

5.引号绕过：16进制、char()

```sql
-- hex 编码
SELECT * FROM Users WHERE username = 0x61646D696E
-- char() 函数
SELECT * FROM Users WHERE username = CHAR(97,100, 109, 105, 110)
```



#### 可能出现sql注入的地方？

1.根据日期查询信息处

因为日期信息存在反斜杠等符号所以大部分防止sql注入的函数都不能用在该处。

2.登录框

3.登录时的x-forwarded-for注入

现在的后台基本都会有这个功能,在登录的时候会获取ip,然后update写到数据库并后台写死sql语句。
如果是php的程序,就基本都是x-forwarded-for获取ip,然后将其写到数据库。
因为获取的ip会有小数点,所以有些防注入的函数也不能用在该处,sql注入就产生了。

4.删除处

5.注册检测用户是否存在

6.二维码处的sql注入

选择二维码登录时，会不停的post一个数据包来验证手机的扫描，其中的参数可能存在注入。

7.api接口的注入

#### 修复方案？

1.使用参数化查询

2.输入验证和过滤，过滤敏感函数、关键字

3.最小权限原则，给予数据库用户基于网站正常运行的最小权限

4.使用ORM框架，以面向对象的的方式操作数据库，代码中不涉及sql语句

5.使用防火墙和入侵检测系统IDS